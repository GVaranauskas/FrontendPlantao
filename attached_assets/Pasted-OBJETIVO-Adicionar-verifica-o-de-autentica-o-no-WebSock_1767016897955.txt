OBJETIVO: Adicionar verificação de autenticação no WebSocket /ws/import para evitar que usuários não autorizados recebam notificações em tempo real de importações.

CONTEXTO: O WebSocket atual aceita qualquer conexão sem verificar token JWT, permitindo que qualquer pessoa monitore importações de dados sensíveis em tempo real.

ARQUIVOS A MODIFICAR:
1. server/routes.ts (seção do WebSocket)

INSTRUÇÕES DETALHADAS:

1. Localize a seção do WebSocket no arquivo server/routes.ts:
```typescript
httpServer.on("upgrade", (request, socket, head) => {
  if (request.url === "/ws/import") {
    wss.handleUpgrade(request, socket, head, (ws) => {
      wss.emit("connection", ws, request);
    });
  } else {
    socket.destroy();
  }
});
```

2. Adicione uma função auxiliar para extrair token do WebSocket request.

3. Modifique o handler de "upgrade" para validar o token antes de fazer o upgrade.

CÓDIGO A APLICAR:

Adicione esta função auxiliar ANTES da seção do WebSocket:
```typescript
// Helper function to extract token from WebSocket request
function extractTokenFromWsRequest(request: any): string | null {
  // Try query parameter first (?token=...)
  const url = new URL(request.url || '', 'http://localhost');
  const tokenFromQuery = url.searchParams.get('token');
  if (tokenFromQuery) {
    return tokenFromQuery;
  }

  // Try Authorization header
  const authHeader = request.headers['authorization'];
  if (authHeader?.startsWith('Bearer ')) {
    return authHeader.slice(7);
  }

  // Try cookie
  const cookies = request.headers['cookie'];
  if (cookies) {
    const match = cookies.match(/accessToken=([^;]+)/);
    if (match) {
      return match[1];
    }
  }

  return null;
}
```

Substitua a seção httpServer.on("upgrade") por:
```typescript
httpServer.on("upgrade", (request, socket, head) => {
  if (request.url?.startsWith("/ws/import")) {
    // Authenticate WebSocket connection
    const token = extractTokenFromWsRequest(request);
    
    if (!token) {
      logger.warn('[WebSocket] Connection rejected: No token provided');
      socket.write('HTTP/1.1 401 Unauthorized\r\n\r\n');
      socket.destroy();
      return;
    }

    const payload = verifyAccessToken(token);
    if (!payload) {
      logger.warn('[WebSocket] Connection rejected: Invalid token');
      socket.write('HTTP/1.1 401 Unauthorized\r\n\r\n');
      socket.destroy();
      return;
    }

    // Token válido - permitir upgrade
    logger.info(`[WebSocket] Connection authenticated for user: ${payload.username}`);
    
    wss.handleUpgrade(request, socket, head, (ws) => {
      // Attach user info to ws connection
      (ws as any).userId = payload.userId;
      (ws as any).username = payload.username;
      wss.emit("connection", ws, request);
    });
  } else {
    socket.destroy();
  }
});
```

Adicione o import necessário no topo do arquivo (se ainda não existir):
```typescript
import { verifyAccessToken } from "./security/jwt";
```

VALIDAÇÃO APÓS APLICAR:
1. Tentar conectar ao WebSocket sem token deve retornar 401
2. Conectar com token inválido deve retornar 401
3. Conectar com token válido deve funcionar normalmente
4. Notificações de import devem continuar funcionando

TESTE MANUAL NO CONSOLE DO NAVEGADOR:
```javascript
// Sem token - deve falhar
const ws1 = new WebSocket('ws://localhost:5000/ws/import');

// Com token - deve funcionar
const token = localStorage.getItem('accessToken');
const ws2 = new WebSocket(`ws://localhost:5000/ws/import?token=${token}`);

ws2.onopen = () => console.log('Connected!');
ws2.onmessage = (e) => console.log('Message:', JSON.parse(e.data));
```

IMPORTANTE:
- NÃO modifique a lógica de broadcast de eventos
- NÃO altere o formato das mensagens WebSocket
- NÃO modifique o comportamento dos clientes conectados
- Apenas adicione a verificação de autenticação

CHECKLIST DE SEGURANÇA:
☐ WebSocket rejeita conexões sem token (401)
☐ WebSocket rejeita conexões com token inválido (401)
☐ WebSocket aceita conexões com token válido
☐ userId e username são anexados à conexão
☐ Broadcast de eventos continua funcionando
☐ Frontend não quebrou