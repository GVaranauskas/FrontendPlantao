OBJETIVO: Adicionar autenticação obrigatória em todas as rotas de análise clínica de IA que processam dados sensíveis de pacientes.

CONTEXTO: As rotas /api/ai/* processam dados clínicos sensíveis com IA mas algumas podem estar sem proteção adequada. Essas rotas são especialmente críticas pois geram insights médicos.

ARQUIVOS A MODIFICAR:
1. server/routes.ts (seção de rotas de IA)

INSTRUÇÕES DETALHADAS:

1. Localize TODAS as rotas que começam com /api/ai/ no arquivo server/routes.ts:
   - POST /api/ai/analyze-patient/:id
   - POST /api/ai/analyze-patients
   - POST /api/ai/care-recommendations/:id
   - POST /api/ai/clinical-analysis/:id
   - POST /api/ai/clinical-analysis-batch
   - GET /api/admin/cache-stats

2. Verifique se TODAS já têm authMiddleware e requireRole.

3. Onde estiver faltando, adicione conforme o padrão.

CÓDIGO A VERIFICAR E CORRIGIR:

Todas as rotas de IA devem seguir este padrão:
```typescript
app.post("/api/ai/clinical-analysis/:id", 
  authMiddleware,  // Já existe? Se não, adicionar!
  requireRole('admin', 'enfermagem'),  // Verificar se está correto
  asyncHandler(async (req, res) => {
    // ... código existente não deve ser alterado
  })
);
```

PADRÕES ESPECÍFICOS:

Para rotas de análise clínica (usadas pela enfermagem):
```typescript
// ✅ CORRETO - admin + enfermagem
app.post("/api/ai/clinical-analysis/:id", 
  authMiddleware,
  requireRole('admin', 'enfermagem'),  // Nota: 'enfermagem' não 'enfermeiro'
  asyncHandler(async (req, res) => { ... })
);
```

Para rotas administrativas:
```typescript
// ✅ CORRETO - apenas admin
app.get("/api/admin/cache-stats", 
  authMiddleware,
  requireRole('admin'),
  asyncHandler(async (req, res) => { ... })
);
```

ATENÇÃO ESPECIAL:
No código atual, algumas rotas usam requireRole('admin', 'enfermeiro') mas o role correto no sistema é 'enfermagem' (conforme schema.ts). Verifique e corrija se necessário:

ERRADO:
```typescript
requireRole('admin', 'enfermeiro')  // ❌ Role não existe
```

CORRETO:
```typescript
requireRole('admin', 'enfermagem')  // ✅ Role correto conforme schema
```

LISTA DE ROTAS A VERIFICAR:
1. POST /api/ai/analyze-patient/:id → admin + enfermagem
2. POST /api/ai/analyze-patients → admin + enfermagem
3. POST /api/ai/care-recommendations/:id → admin + enfermagem
4. POST /api/ai/clinical-analysis/:id → admin + enfermagem
5. POST /api/ai/clinical-analysis-batch → admin + enfermagem
6. GET /api/admin/cache-stats → apenas admin

VALIDAÇÃO APÓS APLICAR:
1. Todas rotas /api/ai/* retornam 401 sem token
2. Usuário com role 'enfermagem' acessa rotas de análise clínica
3. Usuário com role 'admin' acessa todas as rotas
4. Análises de IA continuam funcionando normalmente
5. Cache de respostas não foi afetado

IMPORTANTE:
- NÃO modifique a lógica de chamada às APIs de IA (OpenAI, Anthropic)
- NÃO altere o sistema de cache (changeDetection, intelligentCache)
- NÃO modifique a estrutura das respostas JSON
- NÃO altere os algoritmos de análise clínica
- Apenas adicione/corrija middlewares de autenticação

CHECKLIST DE SEGURANÇA:
☐ Todas rotas /api/ai/* verificadas
☐ authMiddleware presente em todas
☐ requireRole correto (enfermagem, não enfermeiro)
☐ Rotas admin só para admin
☐ Todas retornam 401 sem autenticação
☐ Funcionalidade de IA não foi alterada
☐ Sistema de cache continua funcionando